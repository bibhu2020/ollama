name: Deploy to Hugging Face Space

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Normalize Inputs
        run: |
          HF_USERNAME_LOWER=$(echo "${{ secrets.HF_USERNAME }}" | awk '{$1=$1};1' | tr '[:upper:]' '[:lower:]')
          SPACE_NAME_LOWER=$(echo "${{ secrets.SPACE_NAME }}" | awk '{$1=$1};1' | tr '[:upper:]' '[:lower:]')
          echo "HF_USERNAME_LOWER=$HF_USERNAME_LOWER" >> $GITHUB_ENV
          echo "SPACE_NAME_LOWER=$SPACE_NAME_LOWER" >> $GITHUB_ENV

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Hugging Face Hub
        run: pip install --upgrade huggingface_hub

      - name: Validate / Create Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: ${{ env.HF_USERNAME_LOWER }}
          SPACE_NAME: ${{ env.SPACE_NAME_LOWER }}
        run: |
          python << 'EOF'
          import os
          import sys
          from huggingface_hub import HfApi

          token = os.environ["HF_TOKEN"]
          username = os.environ["HF_USERNAME"]
          space = os.environ["SPACE_NAME"]

          repo_id = f"{username}/{space}"
          api = HfApi(token=token)

          try:
              info = api.repo_info(repo_id=repo_id, repo_type="space")
              print(f"Space exists: {info.id} (sdk={info.sdk})")
          except Exception as e:
              if "404" in str(e):
                  print("Space not found. Creating...")
                  api.create_repo(
                      repo_id=repo_id,
                      repo_type="space",
                      space_sdk="gradio",   # change if needed
                      private=False
                  )
                  print("Space created.")
              else:
                  raise
          EOF

      - name: Upload repository files to Hugging Face Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: ${{ env.HF_USERNAME_LOWER }}
          SPACE_NAME: ${{ env.SPACE_NAME_LOWER }}
        run: |
          python << 'EOF'
          import os
          from huggingface_hub import HfApi

          api = HfApi(token=os.environ["HF_TOKEN"])
          repo_id = f'{os.environ["HF_USERNAME"]}/{os.environ["SPACE_NAME"]}'

          print(f"Uploading files to {repo_id}...")

          api.upload_folder(
              folder_path=".",
              repo_id=repo_id,
              repo_type="space",
              ignore_patterns=[
                  ".git/*",
                  ".github/*",
                  "__pycache__/*",
                  "*.pyc",
                  ".venv/*"
              ]
          )

          print("Upload completed successfully.")
          EOF
