name: Deploy to Hugging Face Space

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Normalize Inputs
        # Create consistent lowercase variables for all steps to avoid case-sensitivity issues
        run: |
          echo "HF_USERNAME_LOWER=$(echo "${{ secrets.HF_USERNAME }}" | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV
          echo "SPACE_NAME_LOWER=$(echo "${{ secrets.SPACE_NAME }}" | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Validate and Setup Hugging Face Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          # Pass the lowercased env vars to the script
          HF_USERNAME: ${{ env.HF_USERNAME_LOWER }}
          SPACE_NAME: ${{ env.SPACE_NAME_LOWER }}
        run: |
          pip install huggingface_hub
          cat << 'EOF' > setup_space.py
          import os
          import sys
          from huggingface_hub import HfApi
          
          try:
              token = os.environ.get('HF_TOKEN')
              if not token:
                  print('::error::HF_TOKEN is missing')
                  sys.exit(1)
                  
              api = HfApi(token=token)
              
              # Verify login
              try:
                  user = api.whoami()
                  print(f'Authenticated as: {user["name"]}')
              except Exception as e:
                  print(f'::error::Authentication failed: {e}')
                  sys.exit(1)
              
              # Use the normalized variables provided by GITHUB_ENV
              username = os.environ.get('HF_USERNAME')
              space = os.environ.get('SPACE_NAME')
              
              print(f'Configuring Space: {username}/{space}')
              repo_id = f'{username}/{space}'
              
              # Check/Create Repo
              try:
                  info = api.repo_info(repo_id=repo_id, repo_type='space')
                  print(f'Repo found: {info.id}')
                  print(f'Current SDK: {info.sdk}')
                  if info.sdk != 'docker':
                       print(f'::error::Repo exists but SDK is "{info.sdk}", not "docker". Cannot deploy Docker image.')
                       sys.exit(1)
              except Exception as e:
                  if '404' in str(e):
                      print('Repo not found, creating...')
                      api.create_repo(repo_id=repo_id, repo_type='space', space_sdk='docker')
                      print('Repo created successfully.')
                  else:
                      print(f'::error::Failed to check repo info: {e}')
                      sys.exit(1)

          except Exception as e:
              print(f'::error::Setup script failed: {e}')
              sys.exit(1)
          EOF
          
          python setup_space.py

      - name: Login to Hugging Face Registry
        # Use the SAME lowercase username for login
        run: echo "${{ secrets.HF_TOKEN }}" | docker login registry.hf.space -u ${{ env.HF_USERNAME_LOWER }} --password-stdin

      - name: Build and Push Docker Image
        env:
          HF_USERNAME: ${{ env.HF_USERNAME_LOWER }}
          SPACE_NAME: ${{ env.SPACE_NAME_LOWER }}
        run: |
          # Use the explicitly lowercased variables
          IMAGE_TAG="registry.hf.space/$HF_USERNAME/$SPACE_NAME:latest"
          
          echo "Building image: $IMAGE_TAG"
          docker build -t $IMAGE_TAG .
          
          echo "Pushing image to Hugging Face Space..."
          docker push $IMAGE_TAG
