name: Deploy to Hugging Face Space

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate and Setup Hugging Face Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
          SPACE_NAME: ${{ secrets.SPACE_NAME }}
        run: |
          pip install huggingface_hub
          cat << 'EOF' > setup_space.py
          import os
          import sys
          from huggingface_hub import HfApi
          
          try:
              token = os.environ.get('HF_TOKEN')
              if not token:
                  print('::error::HF_TOKEN is missing')
                  sys.exit(1)
                  
              api = HfApi(token=token)
              
              # Verify login
              try:
                  user = api.whoami()
                  print(f'Authenticated as: {user["name"]}')
              except Exception as e:
                  print(f'::error::Authentication failed: {e}')
                  sys.exit(1)
              
              # Prepare Lowercase Names
              username = os.environ.get('HF_USERNAME', '').lower()
              space = os.environ.get('SPACE_NAME', '').lower()
              
              if not username or not space:
                   print('::error::HF_USERNAME or SPACE_NAME is missing')
                   sys.exit(1)
                   
              repo_id = f'{username}/{space}'
              print(f'Targeting Repo: {repo_id}')
              
              # Check/Create Repo
              try:
                  info = api.repo_info(repo_id=repo_id, repo_type='space')
                  print(f'Repo found. Current SDK: {info.sdk}')
                  if info.sdk != 'docker':
                       print(f'::error::Repo exists but SDK is "{info.sdk}", not "docker". Cannot deploy Docker image.')
                       sys.exit(1)
              except Exception as e:
                  if '404' in str(e):
                      print('Repo not found, creating...')
                      api.create_repo(repo_id=repo_id, repo_type='space', space_sdk='docker')
                      print('Repo created successfully.')
                  else:
                      print(f'::error::Failed to check repo info: {e}')
                      sys.exit(1)

          except Exception as e:
              print(f'::error::Setup script failed: {e}')
              sys.exit(1)
          EOF
          
          python setup_space.py

      - name: Login to Hugging Face Registry
        run: echo "${{ secrets.HF_TOKEN }}" | docker login registry.hf.space -u ${{ secrets.HF_USERNAME }} --password-stdin

      - name: Build and Push Docker Image
        env:
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
          SPACE_NAME: ${{ secrets.SPACE_NAME }}
        run: |
          # Docker requires lowercase for repository names
          HF_USERNAME_LOWER=$(echo "$HF_USERNAME" | tr '[:upper:]' '[:lower:]')
          SPACE_NAME_LOWER=$(echo "$SPACE_NAME" | tr '[:upper:]' '[:lower:]')
          IMAGE_TAG="registry.hf.space/$HF_USERNAME_LOWER/$SPACE_NAME_LOWER:latest"
          
          echo "Building image: $IMAGE_TAG"
          docker build -t $IMAGE_TAG .
          
          echo "Pushing image to Hugging Face Space..."
          docker push $IMAGE_TAG
